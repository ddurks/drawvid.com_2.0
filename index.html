<!DOCTYPE html>
<html>
  <head>
		<meta charset="utf-8">
    <title>drawvid.com</title>
    <style>
      body {
        padding: 0;
        background-color:#006bff;
      }
      canvas {
        display: block;
        margin:0;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: blanchedalmond;
        z-index: 0;
      }
      .standardButton {
        z-index: 2147483647;
        position: absolute;
        background: #7C7C7C;
        border-bottom: 6px inset rgba(0,0,0,.5);
        border-left: 6px inset rgba(0,0,0,.5);
        border-right: 6px inset rgba(255,255,255,.5);
        border-top: 6px inset rgba(255,255,255,.5);
        box-sizing: border-box;
        color: white;
        cursor: pointer;
        display: block;
        font-size: 1rem;
        margin: auto;
        padding: .5rem;
        width: auto;
      }
      button.standardButton {
        top: 75%;
        left: 52%;
      }
      input.standardButton {
        background: rgb(197, 197, 197);
        color: black;
        top: 75%;
        left: 43%;
      }
    </style>
  </head>
  <body>
    <script>
      var CANVAS_WIDTH = 512;
      var CANVAS_HEIGHT = 512;
      var WINDOW_WIDTH = window.innerWidth;
      var WINDOW_HEIGHT = window.innerHeight;
      var DOCUMENT = document;
      const RENDER_DELAY = 0.005;
      const ANIMATION_DELAY = 0.15;
      const MARCH_DELAY = 0.75;
      const PLAYER_SPEED = 150;
      const PLAYER_ACTION = {
        sit: -1,
        right: 0,
        down: 1,
        left: 2,
        up: 3
      }
      const KEY_CODES = {
        w: 87,
        a: 65,
        s: 83,
        d: 68,
        space: 32,
        arrowleft: 37,
        arrowright: 39
      }

      var IS_MOBILE;
      if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent) 
          || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4))) { 
        IS_MOBILE = true;
      } else {
        IS_MOBILE = false;
      }
      //console.log("is mobile: ", IS_MOBILE);
      var supportsPassive = false;
      try {
        window.addEventListener("test", null, Object.defineProperty({}, 'passive', {
          get: function () { supportsPassive = true; } 
        }));
      } catch(e) {}
      var wheelOpt = supportsPassive ? { passive: false } : false;
      function preventDefault(e) {
        e.preventDefault();
      }
      if (IS_MOBILE) {
        window.addEventListener('touchmove', preventDefault, wheelOpt);
      }

      const Utility = {
        resize: function() {
          var canvas = document.getElementById("drawvidWorld-canvas");
          var windowWidth = window.innerWidth;
          var windowHeight = window.innerHeight;
          CANVAS_WIDTH = windowWidth;
          CANVAS_HEIGHT = windowWidth;
          WINDOW_WIDTH = windowWidth;
          WINDOW_HEIGHT = windowHeight;
          var windowRatio = windowWidth / windowHeight;
          var gameRatio = CANVAS_WIDTH / CANVAS_HEIGHT;
          if(windowRatio < gameRatio){
              canvas.style.width = windowWidth + "px";
              canvas.style.height = (windowWidth / gameRatio) + "px";
          }
          else{
              canvas.style.width = (windowHeight * gameRatio) + "px";
              canvas.style.height = windowHeight + "px";
          }
        },
        getTimestamp: function() {
          return Date.now() / 1000.0;
        },
        getRandomInt: function(min, max) {
          min = Math.ceil(min);
          max = Math.floor(max);
          return Math.floor(Math.random() * (max - min + 1)) + min;
        },
        getAngle: function(cx, cy, ex, ey) {
          var dy = ey - cy;
          var dx = ex - cx;
          var theta = Math.atan2(dy, dx); // range (-PI, PI]
          theta *= 180 / Math.PI; // rads to degs, range (-180, 180]
          //if (theta < 0) theta = 360 + theta; // range [0, 360)
          return theta;
        }
      };

      const Entity = {
        create: function(x_position, y_position, action, vx, vy) {
          var entity = Object.create(this);
          entity.x = x_position;
          entity.y = y_position;
          entity.action = action;
          entity.vx = vx;
          entity.vy = vy;
          return entity;
        }
      }

      const Player = {
        height: 64,
        width: 64,
        left_boundary: 0,
        right_boundary: CANVAS_WIDTH,
        dead: false,

        create: function(x_position, y_position, action) {
          var player = Object.create(this);
          player.state = Entity.create(x_position, y_position, action, 0, 0);
          player.frame = 0;
          return player;
        },

        setSpeedX: function(vx) {
          console.log("set speed X");
          if (vx > PLAYER_SPEED/5) {
            this.state.action = PLAYER_ACTION.right;
            this.state.vx = vx;
          } else if (vx < -PLAYER_SPEED/5) {
            this.state.action = PLAYER_ACTION.left;
            this.state.vx = vx;
          }
        },

        setSpeedY: function(vy) {
          if (vy > PLAYER_SPEED/5) {
            this.state.action = PLAYER_ACTION.down;
            this.state.vy = vy;
          } else if (vy < -PLAYER_SPEED/5) {
            this.state.action = PLAYER_ACTION.up;
            this.state.vy = vy;
          }
        },

        idle: function() {
          this.state.action = PLAYER_ACTION.sit;
          this.state.vy = 0;
          this.state.vx = 0;
          this.frame = 0;
        },

        updatePlayer(deltat) {
          if (this.state.x >= 0 && this.state.x <= CANVAS_WIDTH-this.width-1) {
            this.updatePosition(deltat);
          } else {
            if (this.state.x < 0) {
              this.state.x = 0;
            } else if (this.state.x > CANVAS_WIDTH) {
              this.state.x = 511;
            }
          }
        },

        updateAuto(deltat) {
          if (this.state.x + this.state.vx * deltat >= this.left_boundary && this.state.x <= this.right_boundary-this.width) {
            this.updatePosition(deltat);
          } else {
            if (this.state.x < 0) {
              this.state.x = 0;
            } else if (this.state.x > this.right_boundary-this.width) {
              this.state.x = this.right_boundary - this.width;
            }
            this.setSpeedX(this.state.vx * -1);
            this.setSpeedY(this.state.vy * -1);
            this.updatePosition(deltat);
          }
        },

        updatePosition: function(deltat) {
          console.log(this.state.vx, this.state.vy);
          this.state.x = this.state.x + this.state.vx * deltat;
          this.state.y = this.state.y + this.state.vy * deltat;
        },

        cycleAnimationFrame: function() {
          if (this.frame < 3) {
            this.frame++
          } else {
            this.frame = 0;
          }
        }
      }

      const DrawvidWorld = {
        player: null,
        players: new Array(),

        create: function() {
          var drawvidWorld = Object.create(this);
          drawvidWorld.bg = Entity.create(0, 0, 0, 0, 0);
          drawvidWorld.player = Player.create(Utility.getRandomInt(0, CANVAS_WIDTH), Utility.getRandomInt(0, CANVAS_HEIGHT), -1);
          drawvidWorld.game_over = false;
          return drawvidWorld;
        },

        updateAllPlayers: function(deltat) {
          if(this.player != null) {
            this.player.updatePlayer(deltat);
          }
          this.players.forEach(function(player){
            player.updateAuto(deltat);
          });
        },
      

        updateSimulationState: function(deltat) {

        },

        spawn: function() {
          this.spawnPlayer();
        },

        spawnPlayer: function(xDimension, yDimension) {
          if(this.player != null){
            var newPlayer = Player.create(Utility.getRandomInt(0, CANVAS_WIDTH), Utility.getRandomInt(0, CANVAS_HEIGHT), Utility.getRandomInt(-1, 1));
            this.players.push(newPlayer);
          }
        },

        grazePlayers: function() {
          if(this.player != null) {
            this.players.forEach(function(player){
              switch(Utility.getRandomInt(1,5)) {
                case 1:
                  player.setSpeedX(Utility.getRandomInt(-PLAYER_SPEED, PLAYER_SPEED));
                  player.setSpeedY(0);
                  break;
                case 2:
                  player.idle();
                  break;
                case 3:
                  player.setSpeedX(0);
                  player.setSpeedY(Utility.getRandomInt(-PLAYER_SPEED, PLAYER_SPEED));
                  break;
              }
            });
          }
        },

        updateSimulation: function(deltat) {
          this.updateSimulationState(deltat);
          this.updateAllPlayers(deltat);
        }
      }

      const Controller =  {
        bg_img: new Image(),
        playerUpImg: new Image(),
        playerDownImg: new Image(),
        playerLeftImg: new Image(),
        playerRightImg: new Image(),
        playerIdleImg: new Image(),
        KeyState: {
          key: [0,0,0,0],
          changeKey: function(which, to) {
            switch (which) {
              case KEY_CODES.a: // a/arrowleft left
              case KEY_CODES.arrowleft:
                this.key[0] = to;
                break;
              case KEY_CODES.d: // d/arrowright right
              case KEY_CODES.arrowright:
                this.key[1] = to;
                break;
              case KEY_CODES.w: // w up
                this.key[2] = to;
                break;
              case KEY_CODES.s: // s down
                this.key[3] = to;
                break;
            }
          },
          keyFromAngleAndLocation(angle, x, y) {
            if (y <= PLAYER_HOME_Y) { //loc above ground jump
              this.key[2] = 1
            }
            if (angle < 90 && angle > -90) { //loc right side right
                this.key[1] = 1;
            } else { //loc left side left
              this.key[0] = 1;
            }
          },
          clearKeys() {
            for(i=0; i< this.key.length; i++) {
              this.key[i] = 0;
            }
          }
        },

        getTouchPos: function(touchEvent) {
          var rect = this.canvas.getBoundingClientRect();
          return {
            x: (touchEvent.touches[0].clientX - rect.left) * CANVAS_WIDTH/rect.width,
            y: (touchEvent.touches[0].clientY - rect.top) * CANVAS_HEIGHT/rect.height
          };
        },

        create: function() {
          var view = Object.create(this);
          view.world = DrawvidWorld.create();
          view.canvas = DOCUMENT.createElement("canvas");
          view.canvas.id = "drawvidWorld-canvas";
          view.context = view.canvas.getContext("2d");
          view.canvas.width = WINDOW_WIDTH;
          view.canvas.height = WINDOW_HEIGHT;
          CANVAS_WIDTH = view.canvas.width;
          CANVAS_HEIGHT = view.canvas.height;
          DOCUMENT.body.appendChild(view.canvas);
          view.context.imageSmoothingEnabled = false;
          var assets = "assets/";
          //view.bg_img.src = assets + "bg.png";
          view.playerUpImg.src = assets + "lildrawvid_up.png";
          view.playerDownImg.src = assets + "lildrawvid_down.png";
          view.playerLeftImg.src = assets + "lildrawvid_left.png";
          view.playerRightImg.src = assets + "lildrawvid_right.png";
          view.playerIdleImg.src = assets + "lildrawvid.png";
          view.curr_timestamp = Utility.getTimestamp();
          view.graze_delay = Utility.getRandomInt(1, 5);
          view.spawn_delay = 3;
          view.start();
          return view;
        },

        handleInput: function() {
          if(this.KeyState.key[0] || this.KeyState.key[1] || this.KeyState.key[2] || this.KeyState.key[3]) {
            if(this.KeyState.key[0] && this.world.player.state.vx >= 0){ // left
              this.world.player.setSpeedX(-PLAYER_SPEED);
              this.world.player.setSpeedY(0);
              console.log("left");
            }
            if(this.KeyState.key[1] && this.world.player.state.vx <= 0){ // right
              this.world.player.setSpeedX(PLAYER_SPEED);
              this.world.player.setSpeedY(0);
              console.log("right");
            }
            if(this.KeyState.key[2] && this.world.player.state.vy >= 0){ // up
              this.world.player.setSpeedX(0);
              this.world.player.setSpeedY(-PLAYER_SPEED);
              console.log("up");
            }
            if(this.KeyState.key[3] && this.world.player.state.vy <= 0){ // down
              this.world.player.setSpeedX(0);
              this.world.player.setSpeedY(PLAYER_SPEED);
              console.log("down");
            }
          }
        },

        handleKeyup: function(keyCode) {
          if(keyCode === KEY_CODES.a || keyCode === KEY_CODES.arrowleft || keyCode === KEY_CODES.d || keyCode === KEY_CODES.arrowright || keyCode === KEY_CODES.w || keyCode === KEY_CODES.s) {
            this.world.player.setSpeedX(0);
            this.world.player.setSpeedY(0);
            this.world.player.idle();
          }
        },
        handleTouchend: function() {
          this.world.player.setSpeedX(0);
          this.world.player.setSpeedY(0);
          this.world.player.idle();
        },

        renderWorld: function() {
          this.context.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
          this.drawBg();
          this.drawPlayers();
        },

        drawBg: function() {
          //this.context.drawImage(this.bg_img, this.world.bg.x, this.world.bg.y);
        },

        drawText: function(txt, x, y, size) {
          this.context.font = size + 'px sans-serif';
          this.context.font.style = "bold";
          this.context.fillText(txt, x, y);
        },

        drawPlayer: function(player) {
          var img;
          switch(player.state.action) {
            case PLAYER_ACTION.left:
              img = this.playerLeftImg;
              break;
            case PLAYER_ACTION.right:
              img = this.playerRightImg;
              break; 
            case PLAYER_ACTION.up:
              img = this.playerUpImg;
              break; 
            case PLAYER_ACTION.down:
              img = this.playerDownImg;
              break; 
            default:
              img = this.playerIdleImg;
          }
          this.context.fillStyle = 'green';
          this.context.beginPath();
          this.context.ellipse(player.x + 32, player.y + 100, 32, 16, Math.PI / 4, 0, 2 * Math.PI);
          this.context.fill();
          this.context.drawImage(img, player.frame * 64, 0, 64, 64, player.state.x, player.state.y, 64, 64);
        },

        drawPlayers: function() {
          if(this.world.game_over) {
            this.context.globalAlpha = 0.50;
          }
          if(this.world.player != null) {
            this.drawPlayer(this.world.player);
          }
          this.world.players.forEach( function(player) {
            this.drawPlayer(player);
          }.bind(this));
          if(this.world.game_over) {
            this.context.globalAlpha = 1.0;
          }
        },

        animateWorld: function() {
          if (this.world.player != null) {
            this.world.player.cycleAnimationFrame();
          }
          this.world.players.forEach(function(player) {
            player.cycleAnimationFrame();
          });
        },

        step: function() {
          this.prev_timestamp = this.curr_timestamp;
          this.curr_timestamp = Utility.getTimestamp();

          // SIMULATE //
          if(!!this.world.player) {
            this.handleInput();
          }
          var deltat = this.curr_timestamp - this.prev_timestamp;
          this.world.updateSimulation(deltat);

          var spawn_deltat = this.curr_timestamp - this.last_spawn_timestamp;
          if(spawn_deltat > this.spawn_delay) {
            this.world.spawn();
            // SPAWN DELAY FUNCTION
            var totalTime = this.curr_timestamp - this.start_timestamp;
            var maxDelay = parseInt( (6 / (1 + 5 * Math.exp(-(1/15)*(totalTime)))) , 10);
            var minDelay = parseInt(totalTime/180, 10) + 1;
            if(minDelay > 4) {
              minDelay = 4;
            }
            this.spawn_delay = Utility.getRandomInt(minDelay, maxDelay);
            //console.log(this.curr_timestamp - this.start_timestamp, this.spawn_delay);
            //console.log("new delay: " + this.spawn_delay +  " min: " + minDelay + " max: " + maxDelay);
            this.last_spawn_timestamp = Utility.getTimestamp();
          }
          var graze_deltat = this.curr_timestamp - this.last_graze_timestamp;
          if(graze_deltat > this.graze_delay){
            this.world.grazePlayers();
            this.graze_delay = Utility.getRandomInt(1,5);
            this.last_graze_timestamp = Utility.getTimestamp();
          }
          // GAME OVER STATE //
          if(this.world.game_over) {

          }

          // RENDER //
          var render_deltat = Utility.getTimestamp() - this.last_render_timestamp;
          if(render_deltat > RENDER_DELAY) {
            this.renderWorld();
            this.last_render_timestamp = Utility.getTimestamp();
          }

          // ANIMATE //
          var animation_frame_deltat = Utility.getTimestamp() - this.last_animation_frame_timestamp;
          if(animation_frame_deltat > ANIMATION_DELAY) {
            this.animateWorld();
            this.last_animation_frame_timestamp = Utility.getTimestamp();
          }
          
          window.requestAnimationFrame(function() {
            this.step();
          }.bind(this));
        },

        initSimulationLoop: function() {
          var timestamp = Utility.getTimestamp();
          this.last_render_timestamp = timestamp;
          this.last_animation_frame_timestamp = timestamp;
          this.last_graze_timestamp = timestamp;
          this.last_spawn_timestamp = timestamp;
          window.addEventListener('keydown', function(e) {
            this.KeyState.changeKey(e.keyCode, 1);
            if(this.world.game_over && e.keyCode === KEY_CODES.space) {
              this.restart();
            }
          }.bind(this));
          window.addEventListener('keyup', function(e) {
            this.KeyState.changeKey(e.keyCode, 0);
            this.handleKeyup(e.keyCode);
          }.bind(this));
          if (IS_MOBILE) {
            window.addEventListener('touchstart', function(e) {
              var touch = this.getTouchPos(e);
              if (touch.x < 0) {
                touch.x = 0;
              }
              if (touch.y > CANVAS_HEIGHT) {
                touch.y = CANVAS_HEIGHT;
              }
              if(this.world.game_over) {
                this.restart();
              }
              var angle = Utility.getAngle(this.world.player.state.x + 16, this.world.player.state.y + 16, touch.x, touch.y);
              this.KeyState.keyFromAngleAndLocation(angle, touch.x, touch.y)
            }.bind(this), false);
            window.addEventListener('touchmove', function(e) {
              preventDefault(e);
              var touch = this.getTouchPos(e);
              if (touch.x < 0) {
                touch.x = 0;
              }
              if (touch.y > CANVAS_HEIGHT) {
                touch.y = CANVAS_HEIGHT;
              }
              this.KeyState.clearKeys();
              var angle = Utility.getAngle(this.world.player.state.x + 16, this.world.player.state.y + 16, touch.x, touch.y);
              this.KeyState.keyFromAngleAndLocation(angle, touch.x, touch.y)
            }.bind(this), wheelOpt);
            window.addEventListener('touchend', function(e) {
              this.KeyState.clearKeys();
              this.handleTouchend();
            }.bind(this), false);
          }
          window.requestAnimationFrame(function() {
            this.step();
          }.bind(this));
        },

        start: function() {
          this.start_timestamp = Utility.getTimestamp();
          this.initSimulationLoop();
        },

        restart: function() {
          this.world = DrawvidWorld.create();
          this.world.player = Player.create(Utility.getRandomInt(0, CANVAS_WIDTH), Utility.getRandomInt(0, CANVAS_HEIGHT), -1);
          this.initSimulationLoop();
        }
      };

      var controller = Controller.create();
      window.addEventListener('resize', function(e){
        controller.context.imageSmoothingEnabled = false;
        Utility.resize();
      }, false);
    </script>
  </body>
</html>